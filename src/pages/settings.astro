---
import Layout from '@l/Layout.astro';
---

<Layout name="Settings">
  <link slot="head" rel="stylesheet" href={replacement + '/assets/css/pages/settings.css'}>
  <div class="main">
    <div class="settings">
      <h2>Settings</h2>
      <div class="field">
        <label for="themesel">Theme</label>
        <select id="themesel"></select>
      </div>
      <p class="author"></p>
      <div class="field">
        <label for="proxysel">Proxy</label>
        <select id="proxysel">
          <option value="scramjet">Scramjet</option>
          <option value="uv">UV</option>
        </select>
      </div>
      <div class="field">
        <label for="transportsel">Transport</label>
        <select id="transportsel">
          <option value="epoxy">Epoxy</option>
          <option value="libcurl">libcurl</option>
        </select>
      </div>
      <div class="actions">
        <button id="savesettings">Save</button>
        <button id="resetsettings" type="button">Reset</button>
      </div>
      <Fragment set:html={`<script>const replacement='${replacement}';</script>`}/>
      <script type="module">
        function applyTheme(theme) {
          const id = 'theme';
          let link = document.getElementById(id);
          const href = `${replacement}/assets/css/themes/${theme}.css`;
          if (!link) {
            link = document.createElement('link');
            link.rel = 'stylesheet';
            link.id = id;
            document.head.appendChild(link);
          }
          link.href = href;
        }

        document.addEventListener('DOMContentLoaded', async () => {
          const themeSelect = document.getElementById('themesel');
          const proxySelect = document.getElementById('proxysel');
          const transportSelect = document.getElementById('transportsel');
          const saveBtn = document.getElementById('savesettings');
          const resetBtn = document.getElementById('resetsettings');
          const originalSaveText = 'Save';
          const savedSaveText = 'Saved âœ“';
          
          let themes = ['default'];
          const response = await fetch(`${replacement}/themes.json`);
          if (response.ok) {
            themes = await response.json();
          }
          
          themes.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t.charAt(0).toUpperCase() + t.slice(1);
            themeSelect.appendChild(opt);
          });

          const savedTheme = localStorage.getItem('theme') || 'default';
          const savedProxy = localStorage.getItem('proxy') || 'scramjet';
          const savedTransport = localStorage.getItem('transport') || 'epoxy';

          themeSelect.value = savedTheme;
          proxySelect.value = savedProxy;
          transportSelect.value = savedTransport;

          applyTheme(themeSelect.value);
          
          let timeoutId = null;

          function setSavedState() {
            saveBtn.textContent = savedSaveText;
            saveBtn.disabled = true;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
              saveBtn.textContent = originalSaveText;
              saveBtn.disabled = false;
            }, 3000);
          }

          saveBtn.addEventListener('click', () => {
            const theme = themeSelect.value;
            const proxy = proxySelect.value;
            const transport = transportSelect.value;

            localStorage.setItem('theme', theme);
            localStorage.setItem('proxy', proxy);
            localStorage.setItem('transport', transport);

            applyTheme(theme);
            setSavedState();
          });

          resetBtn.addEventListener('click', () => {
            localStorage.removeItem('theme');
            localStorage.removeItem('proxy');
            localStorage.removeItem('transport');
            themeSelect.value = 'default';
            proxySelect.value = 'scramjet';
            transportSelect.value = 'epoxy';
            applyTheme('default');
            saveBtn.textContent = originalSaveText;
            saveBtn.disabled = false;
            clearTimeout(timeoutId);
          });
        });
      </script>
    </div>
  </div>
</Layout>