---
import Layout from '@l/Layout.astro';
import Proxy from '@s/Proxy.astro';
import PromptClose from '@s/PromptClose.astro';
import Tabs from '@c/Tabs.astro';
import AddressBar from '@c/AddressBar.astro';
import Bookmarks from '@c/Bookmarks.astro';
const Define = `<script>
    const replacement = '${replacement}';
    const wispVal = '${import.meta.env.wispUrl}';
</script>`;
---

<Layout name="Search">
    <link slot="head" rel="stylesheet" href={replacement + '/assets/css/pages/search.css'}>
    <Fragment set:html={Define} />
	<div id="main browser" class="main">
        <Tabs/>
        <AddressBar/>
        <Bookmarks/>
        <div id="content">
        </div>
	</div>

    <script src={replacement + '/baremux/index.js'} defer></script>
    <Proxy/>
    <script>
        import { iframeLoading, init, getWisp, setTransport, loadUrl, handleSubmit,setupIframe, goBack, goForward, reload, updateNav } from "../utils/proxy";
        import { updateUrl, getActiveTab, newTab } from "../utils/tabs";
        import { bookmarks, bookmarkToggle, updateBookmark } from "../utils/bookmarks";
        
        let config: any = null;
        const params = new URLSearchParams(window.location.search);
        const routeQuery = params.get('q') ?? undefined;

        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'open-new-tab') {
                const url = event.data.url;
                const tabs = document.getElementById('tabs');
                const newtab = document.getElementById('newtab');
                const content = document.getElementById('content');
                
                if (tabs && newtab && content && config) {
                    newTab(tabs, newtab, content, replacement);
                    
                    setTimeout(() => {
                        const activeIframe = document.querySelector('.tab-iframe.active') as HTMLIFrameElement;
                        const urlInput = document.getElementById('url') as HTMLInputElement;
                        
                        if (activeIframe && urlInput) {
                            loadUrl(url, config, activeIframe, urlInput);
                        }
                    }, 100);
                }
            }
        });
        
        document.addEventListener('DOMContentLoaded', async () => {
            const iframe = document.querySelector('.tab-iframe.active') as HTMLIFrameElement | null;
            const url = document.getElementById("url") as HTMLInputElement | null;
            const search = document.getElementById("search") as HTMLFormElement | null;
            const addbookmark = document.getElementById("bookmark-btn");
            const backBtn = document.getElementById("back");
            const forwardBtn = document.getElementById("forward");
            const reloadBtn = document.getElementById("reload");
            
            bookmarks(replacement);
            
            if (routeQuery !== undefined && iframe) {
                iframeLoading(iframe, replacement);
            }
            
            const chicken = init(replacement);
            const wispUrl = getWisp(wispVal);

            const selectedProxy = localStorage.getItem('proxy') || 'chicken';
            const selectedTransport = localStorage.getItem('transport') || 'epoxy';
            const connection = new window.BareMux.BareMuxConnection('/bareworker.js');
            await setTransport(connection, selectedTransport, replacement, wispUrl);
            const config = { replacement, wispVal, chicken, proxy: selectedProxy };

            if (iframe) {
                setupIframe(iframe, config, replacement);
            }

            if (routeQuery !== undefined && iframe && url) {
                const decodedQuery = decodeURIComponent(atob(routeQuery));
                loadUrl(decodedQuery, config, iframe, url);
                
                const activeTab = getActiveTab();
                if (activeTab) {
                    updateUrl(activeTab.getAttribute('data-tab-id') || '', url.value, replacement);
                }
                
                setTimeout(() => updateBookmark(), 500);
            }

            if (search && url) {
                search.addEventListener("submit", (event: Event) => {
                    event.preventDefault();
                    const activeIframe = document.querySelector('.tab-iframe.active') as HTMLIFrameElement;
                    if (activeIframe) {
                        handleSubmit(event, url, config, activeIframe);
                        
                        const activeTab = getActiveTab();
                        if (activeTab) {
                            updateUrl(activeTab.getAttribute('data-tab-id') || '', url.value, replacement);
                        }
                        
                        setTimeout(() => updateBookmark(), 500);
                    }
                });
            }
            
            if (addbookmark) {
                addbookmark.addEventListener('click', () => {
                    bookmarkToggle();
                });
            }
            
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    if (!backBtn.classList.contains('disabled')) {
                        goBack(config);
                    }
                });
            }
            
            if (forwardBtn) {
                forwardBtn.addEventListener('click', () => {
                    if (!forwardBtn.classList.contains('disabled')) {
                        goForward(config);
                    }
                });
            }
            
            if (reloadBtn) {
                reloadBtn.addEventListener('click', () => {
                    reload();
                });
            }
            
            document.addEventListener('click', (e) => {
                const target = e.target as HTMLElement;
                if (target.id === 'tab' || target.closest('#tab')) {
                    setTimeout(() => {
                        updateBookmark();
                        updateNav();
                    }, 100);
                }
            });
            
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node instanceof HTMLIFrameElement && node.classList.contains('tab-iframe')) {
                            setupIframe(node, config, replacement);
                        }
                    });
                });
            });
            
            const content = document.getElementById('content');
            if (content) {
                observer.observe(content, { childList: true });
            }
        });
    </script>
    <PromptClose/>
</Layout>